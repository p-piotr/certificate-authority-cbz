SRC_DIR=src
SRCS=$(wildcard $(SRC_DIR)/*.cpp)
TARGET_DIR=out
OBJ_DIR=$(TARGET_DIR)/obj
DEBUG_OBJ_DIR=$(TARGET_DIR)/obj-debug
OBJS=$(SRCS:$(SRC_DIR)/%.cpp=$(OBJ_DIR)/%.o)
DEBUG_OBJS=$(SRCS:$(SRC_DIR)/%.cpp=$(DEBUG_OBJ_DIR)/%-debug.o)
TARGET=$(TARGET_DIR)/poc
DEBUG_TARGET=$(TARGET_DIR)/poc-debug
CXX=g++
DEPFLAGS=-MMD -MP
CXXFLAGS=-I$(SRC_DIR) -std=c++23
LIBS=-lgmp -lgmpxx -lcrypto

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp
	mkdir -p $(OBJ_DIR)
	$(CXX) $(CXXFLAGS) $(DEPFLAGS) -c $< -o $@

$(DEBUG_OBJ_DIR)/%-debug.o: $(SRC_DIR)/%.cpp
	mkdir -p $(DEBUG_OBJ_DIR)
	$(CXX) $(CXXFLAGS) $(DEPFLAGS) -g -c $< -o $@

all: $(TARGET)

$(TARGET): $(OBJS)
	mkdir -p $(TARGET_DIR)
	$(CXX) $(CXXFLAGS) $(OBJS) $(LIBS) -O3 -o $@

debug: $(DEBUG_TARGET)

$(DEBUG_TARGET): $(DEBUG_OBJS)
	mkdir -p $(TARGET_DIR)
	$(CXX) $(CXXFLAGS) $(DEBUG_OBJS) $(LIBS) -g -o $@

clean:
	rm -rf $(OBJ_DIR) $(DEBUG_OBJ_DIR) $(TARGET) $(DEBUG_TARGET)

# Include dependency files generated by the compiler. If a header changes,
# the corresponding .d file will make make rebuild the affected object.
-include $(OBJS:.o=.d)
-include $(DEBUG_OBJS:.o=.d)
