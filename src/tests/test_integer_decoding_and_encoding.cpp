//TODO: should also compare it against some library

#include <utility>
#include <vector>
#include <iostream>
#include <gmpxx.h>
#include "asn1/asn1.h"
#include "utils/utils.hpp"

using std::cout;
using std::cerr;
using std::endl;
using std::pair;
using std::vector;
using std::string;

int main(){
    using namespace CBZ::Utils;

    vector<pair<string,vector<uint8_t>>> test_values = {
        {"999999999999999999999999999999999999999", {0x02, 0x11, 0x02, 0xF0, 0x50, 0xFE, 0x93, 0x89, 0x43, 0xAC, 0xC4, 0x5F, 0x65, 0x56, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF,} },
        {"12345678901234567890123456789012345678901234567890", {0x02, 0x15, 0x08, 0x72, 0x7F, 0x63, 0x69, 0xAA, 0xF8, 0x3C, 0xA1, 0x50, 0x26, 0x74, 0x7A, 0xF8, 0xC7, 0xF1, 0x96, 0xCE, 0x3F, 0x0A, 0xD2}},
        {"-999999999999999999999999999999999999999", {0x02, 0x11, 0xFD, 0x0F, 0xAF, 0x01, 0x6C, 0x76, 0xBC, 0x53, 0x3B, 0xA0, 0x9A, 0xA9, 0x80, 0x00, 0x00, 0x00, 0x01}},
        {"-12345678901234567890123456789012345678901234567890", {0x02, 0x15, 0xF7, 0x8D, 0x80, 0x9C, 0x96, 0x55, 0x07, 0xC3, 0x5E, 0xAF, 0xD9, 0x8B, 0x85, 0x07, 0x38, 0x0E, 0x69, 0x31, 0xC0, 0xF5, 0x2E}},
        {"0", {0x02, 0x01, 0x00}},
        {"1", {0x02, 0x01, 0x01}},
        {"-1", {0x02, 0x01, 0xff}},
        {"127", {0x02, 0x01, 0x7f}},
        {"128", {0x02, 0x02, 0x00, 0x80}},
        {"255", {0x02, 0x02, 0x00, 0xff}},
        {"256", {0x02, 0x02, 0x01, 0x00}},
        {"-127", {0x02, 0x01, 0x81}},
        {"-128", {0x02, 0x01, 0x80}},
        {"-255", {0x02, 0x02, 0xff, 0x01}},
        {"-256", {0x02, 0x02, 0xff, 0x00}},
        {"18446744073709551616", {0x02, 0x09, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
        {"340282366920938463463374607431768211456", {0x02, 0x11, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
        {"-18446744073709551616", {0x02, 0x09, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
        {"-340282366920938463463374607431768211456", {0x02, 0x11, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}},
        {"32416190071", {0x02, 0x05, 0x07, 0x8c, 0x27, 0xce, 0x77}},
        {"2305843009213693951", {0x02, 0x08, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},
        {"-32416190071", {0x02, 0x05, 0xf8, 0x73, 0xd8, 0x31, 0x89}},
        {"-2305843009213693951", {0x02, 0x08, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01}},
        {"4294967296", {0x02, 0x05, 0x01, 0x00, 0x00, 0x00, 0x00}},
        {"-4294967296", {0x02, 0x05, 0xff, 0x00, 0x00, 0x00, 0x00}},
        {"115792089237316195423570985008687907853269984665640564039457584007913129639935", {0x02, 0x21, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF}},
        {"-115792089237316195423570985008687907853269984665640564039457584007913129639935", {0x02, 0x21, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01}},
    };


    for (const auto &[value, check]: test_values) {
        mpz_class val(value);
        size_t offset = 0;

        cout << "----------------------------------------" << endl;
        cout << "Testing " << val << endl << endl;
        //vector<uint8_t> der = encode_der_integer(val);
        vector<uint8_t> der = CBZ::ASN1::ASN1Integer(val).encode();
        if(der != check){
            cerr << "游린 Encoding mismatch detected" << endl;
            cerr << "Encoded value: ";
            print_bytes(der);
            cerr << "Expected value: ";
            print_bytes(check);
        } else {
            cout << "游릴 Encoding check passed" << endl;
        }

        cout << endl;

        //mpz_class decoded = decode_der_integer(der,offset);
        mpz_class decoded = CBZ::ASN1::ASN1Integer::decode(der, offset).value();
        if (val != decoded){
            cerr << "游린 Decoding mismatch detected";
            cerr << "Decoded value: " << decoded << endl;
        } else {
            cout << "游릴 Decoding check Passed" << endl;
        }

        cout << "----------------------------------------" << endl << endl;;
    }
    return 0;
}
